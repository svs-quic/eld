<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6. Shared Library Versioning &mdash; ELD  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/index.css" type="text/css" />
      <link rel="stylesheet" href="/home/runner/work/eld/eld/obj/tools/eld/docs/userguide/source/_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="8. Image Structure and Generation" href="image_structure_and_generation.html" />
    <link rel="prev" title="5. Diagnostics" href="linker_diagnostics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            ELD
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="linker_overview.html">1. Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="linking_modes_supported.html">2. Supported Linking Modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="supported_targets.html">3. Supported Targets</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_script.html">4. Linker Script</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_diagnostics.html">5. Diagnostics</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Shared Library Versioning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">6.1. Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#key-concepts">6.2. Key Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="#abi-vs-api">6.3. ABI vs API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#backward-compatibility">6.4. Backward Compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="#best-practices">6.5. Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="#nuances">6.6. Nuances</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#examples">6.6.1. Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#soname-usage-example">6.7. SONAME Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#semantic-versioning-example">6.8. Semantic Versioning Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#abi-vs-api-example">6.9. ABI vs API Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#symbolic-link-structure">6.10. Symbolic Link Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id1">6.11. Nuances</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gnu-elf-symbol-versioning">7. GNU ELF Symbol Versioning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#goal">7.1. Goal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#files">7.2. Files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-run">7.3. Build &amp; Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="#inspecting-the-result">7.4. Inspecting the Result</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#b-what-symver-attribute-symver-do">7.4.1. B. What <code class="docutils literal notranslate"><span class="pre">.symver</span></code> / <code class="docutils literal notranslate"><span class="pre">__attribute__((symver))</span></code> Do</a></li>
<li class="toctree-l3"><a class="reference internal" href="#c-what-a-version-script-does">7.4.2. C. What a Version Script Does</a></li>
<li class="toctree-l3"><a class="reference internal" href="#d-elf-sections-used-by-symbol-versioning">7.4.3. D. ELF Sections Used by Symbol Versioning</a></li>
<li class="toctree-l3"><a class="reference internal" href="#e-practical-notes-common-pitfalls">7.4.4. E. Practical Notes &amp; Common Pitfalls</a></li>
<li class="toctree-l3"><a class="reference internal" href="#f-one-page-cheat-sheet">7.4.5. F. One-Page Cheat Sheet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#appendix-quick-commands">7.4.6. Appendix: Quick Commands</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="image_structure_and_generation.html">8. Image Structure and Generation</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_map_files.html">9. Linker Map Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="layout.html">10. Image layout</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_plugins_updated.html">11. Linker Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_optimizations.html">12. Linker Optimization Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="lto_support.html">13. LTO Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_image_details.html">14. Getting Image Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="options/options.html">15. Command-line options</a></li>
<li class="toctree-l1"><a class="reference internal" href="target_specific_features.html">16. Target Specific Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="linker_faq.html">17. Linker support and frequently asked questions!!!</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ELD</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active"><span class="section-number">6. </span>Shared Library Versioning</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="shared-library-versioning">
<h1><span class="section-number">6. </span>Shared Library Versioning<a class="headerlink" href="#shared-library-versioning" title="Permalink to this heading"></a></h1>
<div class="section" id="overview">
<h2><span class="section-number">6.1. </span>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h2>
<p>Shared library versioning is a mechanism used in operating systems to manage different versions of dynamic libraries (.so files on Unix-like systems). It ensures that applications link to the correct version of a library while maintaining compatibility.</p>
</div>
<div class="section" id="key-concepts">
<h2><span class="section-number">6.2. </span>Key Concepts<a class="headerlink" href="#key-concepts" title="Permalink to this heading"></a></h2>
<dl class="simple">
<dt><strong>SONAME</strong></dt><dd><ul class="simple">
<li><p>The SONAME (Shared Object Name) is an identifier embedded in a shared library that represents its ABI (Application Binary Interface) version.</p></li>
<li><p>Applications link against the SONAME, not the actual filename, allowing upgrades without breaking compatibility.</p></li>
</ul>
</dd>
<dt><strong>Semantic Versioning</strong></dt><dd><ul class="simple">
<li><p>Libraries often follow semantic versioning: <cite>MAJOR.MINOR.PATCH</cite>.</p></li>
<li><p><strong>MAJOR</strong>: Changes that break backward compatibility.</p></li>
<li><p><strong>MINOR</strong>: Backward-compatible feature additions.</p></li>
<li><p><strong>PATCH</strong>: Backward-compatible bug fixes.</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="abi-vs-api">
<h2><span class="section-number">6.3. </span>ABI vs API<a class="headerlink" href="#abi-vs-api" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>API (Application Programming Interface)</strong>: The set of functions and symbols exposed by the library.</p></li>
<li><p><strong>ABI (Application Binary Interface)</strong>: The compiled interface, including calling conventions, data types, and memory layout.</p></li>
<li><p>ABI stability is crucial for shared libraries because applications depend on binary compatibility.</p></li>
</ul>
</div>
<div class="section" id="backward-compatibility">
<h2><span class="section-number">6.4. </span>Backward Compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Libraries should maintain backward compatibility within the same major version.</p></li>
<li><p>Breaking ABI changes require incrementing the major version and updating the SONAME.</p></li>
</ul>
</div>
<div class="section" id="best-practices">
<h2><span class="section-number">6.5. </span>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Use SONAME to manage ABI versions.</p></li>
<li><p>Avoid breaking ABI unless necessary.</p></li>
<li><dl class="simple">
<dt>Provide symbolic links:</dt><dd><ul>
<li><p><cite>libexample.so</cite> → <cite>libexample.so.1</cite> → <cite>libexample.so.1.2.3</cite></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>Document changes clearly.</p></li>
</ul>
</div>
<div class="section" id="nuances">
<h2><span class="section-number">6.6. </span>Nuances<a class="headerlink" href="#nuances" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Different distributions may package libraries differently.</p></li>
<li><p>Some systems use <cite>ldconfig</cite> to manage symbolic links.</p></li>
<li><p>Applications may fail if the expected SONAME is missing, even if the actual library file exists.</p></li>
</ul>
<div class="section" id="examples">
<h3><span class="section-number">6.6.1. </span>Examples<a class="headerlink" href="#examples" title="Permalink to this heading"></a></h3>
</div>
</div>
<div class="section" id="soname-usage-example">
<h2><span class="section-number">6.7. </span>SONAME Usage Example<a class="headerlink" href="#soname-usage-example" title="Permalink to this heading"></a></h2>
<p>When building a shared library:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>clang<span class="w"> </span>-shared<span class="w"> </span>-Wl,-soname,libexample.so.1<span class="w"> </span>-o<span class="w"> </span>libexample.so.1.2.3<span class="w"> </span>example.o
</pre></div>
</div>
<p>Resulting files:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libexample.so.1.2.3   # Actual library file
libexample.so.1       # SONAME symlink (ABI version)
libexample.so         # Generic symlink for development
</pre></div>
</div>
<p>Applications link against <cite>libexample.so.1</cite>, not the full filename.</p>
</div>
<div class="section" id="semantic-versioning-example">
<h2><span class="section-number">6.8. </span>Semantic Versioning Example<a class="headerlink" href="#semantic-versioning-example" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>libmath.so.1.0.0 → Initial release</p></li>
<li><p>libmath.so.1.1.0 → Adds new functions (backward-compatible)</p></li>
<li><p>libmath.so.2.0.0 → Changes function signatures (breaks ABI)</p></li>
</ul>
<p>When moving from 1.x.x to 2.x.x, update SONAME to <cite>libmath.so.2</cite>.</p>
</div>
<div class="section" id="abi-vs-api-example">
<h2><span class="section-number">6.9. </span>ABI vs API Example<a class="headerlink" href="#abi-vs-api-example" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p><strong>API Change (safe)</strong>: Adding a new function <cite>add_matrix()</cite> does not break existing binaries.</p></li>
<li><p><strong>ABI Break (unsafe)</strong>: Changing <cite>struct Matrix { int rows; int cols; }</cite> to include a new field changes memory layout, breaking existing binaries.</p></li>
</ul>
</div>
<div class="section" id="symbolic-link-structure">
<h2><span class="section-number">6.10. </span>Symbolic Link Structure<a class="headerlink" href="#symbolic-link-structure" title="Permalink to this heading"></a></h2>
<p>After installation:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/usr/lib/
    libexample.so -&gt; libexample.so.1
    libexample.so.1 -&gt; libexample.so.1.2.3
    libexample.so.1.2.3
</pre></div>
</div>
<p>ASCII Diagram:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>libexample.so → libexample.so.1 → libexample.so.1.2.3
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2><span class="section-number">6.11. </span>Nuances<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>Different Linux distros may package libraries differently.</p></li>
<li><p>If SONAME is missing, apps fail with:</p></li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>error while loading shared libraries: libexample.so.1: cannot open shared object file
</pre></div>
</div>
</div>
</div>
<div class="section" id="gnu-elf-symbol-versioning">
<h1><span class="section-number">7. </span>GNU ELF Symbol Versioning<a class="headerlink" href="#gnu-elf-symbol-versioning" title="Permalink to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Support for symbol versioning is planned for a future release. Stay tuned for updates</p>
</div>
<p>This document continues to show a minimal end-to-end demonstration of GNU ELF symbol
versioning, then documents:</p>
<ol class="arabic simple">
<li><p>What the <code class="docutils literal notranslate"><span class="pre">.symver</span></code> / <code class="docutils literal notranslate"><span class="pre">__attribute__((symver))</span></code> mechanisms do.</p></li>
<li><p>What a GNU ld <em>version script</em> does.</p></li>
<li><p>Which ELF sections the linker/loader create/use for symbol versioning.</p></li>
</ol>
<p>The example exports two versions of the same symbol and preserves
backward compatibility across library releases.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#goal" id="id2">Goal</a></p></li>
<li><p><a class="reference internal" href="#files" id="id3">Files</a></p></li>
<li><p><a class="reference internal" href="#build-run" id="id4">Build &amp; Run</a></p></li>
<li><p><a class="reference internal" href="#inspecting-the-result" id="id5">Inspecting the Result</a></p>
<ul>
<li><p><a class="reference internal" href="#b-what-symver-attribute-symver-do" id="id6">B. What <code class="docutils literal notranslate"><span class="pre">.symver</span></code> / <code class="docutils literal notranslate"><span class="pre">__attribute__((symver))</span></code> Do</a></p></li>
<li><p><a class="reference internal" href="#c-what-a-version-script-does" id="id7">C. What a Version Script Does</a></p></li>
<li><p><a class="reference internal" href="#d-elf-sections-used-by-symbol-versioning" id="id8">D. ELF Sections Used by Symbol Versioning</a></p></li>
<li><p><a class="reference internal" href="#e-practical-notes-common-pitfalls" id="id9">E. Practical Notes &amp; Common Pitfalls</a></p></li>
<li><p><a class="reference internal" href="#f-one-page-cheat-sheet" id="id10">F. One-Page Cheat Sheet</a></p></li>
<li><p><a class="reference internal" href="#appendix-quick-commands" id="id11">Appendix: Quick Commands</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="goal">
<h2><a class="toc-backref" href="#id2"><span class="section-number">7.1. </span>Goal</a><a class="headerlink" href="#goal" title="Permalink to this heading"></a></h2>
<p>Export two versions of an API symbol (<code class="docutils literal notranslate"><span class="pre">foo</span></code>), keeping ABI compatibility
for old applications while making a new implementation the default for
new applications.</p>
</div>
<div class="section" id="files">
<h2><a class="toc-backref" href="#id3"><span class="section-number">7.2. </span>Files</a><a class="headerlink" href="#files" title="Permalink to this heading"></a></h2>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// v1 of the library: exports foo()</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;foo v1&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEMO_1 {
  global: foo;
  local:  *;
};
</pre></div>
</div>
<p>This assigns <code class="docutils literal notranslate"><span class="pre">foo</span></code> to version node <code class="docutils literal notranslate"><span class="pre">DEMO_1</span></code> and hides everything else.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>

<span class="cm">/* Approach A: classic assembler directive (works with GCC &amp; Clang) */</span>
<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;.symver foo_v1,foo@DEMO_1&quot;</span><span class="p">);</span><span class="w">    </span><span class="c1">// non-default (old) foo</span>
<span class="n">__asm__</span><span class="p">(</span><span class="s">&quot;.symver foo_v2,foo@@DEMO_2&quot;</span><span class="p">);</span><span class="w">   </span><span class="c1">// default (new) foo</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">foo_v1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;foo v1&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">foo_v2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;foo v2 (default)&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>

<span class="cm">/* New API symbol in v2 */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;bar v2&quot;</span><span class="p">);</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEMO_1 {
  global: foo;
  local:  *;
};

DEMO_2 {
  global: foo; bar;
} DEMO_1;  /* DEMO_2 inherits from DEMO_1 */
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">foo</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">bar</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">foo</span><span class="p">();</span><span class="w"> </span><span class="n">bar</span><span class="p">();</span><span class="w"> </span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nv">CC</span><span class="o">?=</span>clang
<span class="nv">CFLAGS</span><span class="o">=</span>-fPIC<span class="w"> </span>-O2<span class="w"> </span>-Wall<span class="w"> </span>-Wextra

<span class="nf">all</span><span class="o">:</span><span class="w"> </span><span class="n">stage</span>1 <span class="n">stage</span>2 <span class="n">inspect</span>

<span class="nf">stage1</span><span class="o">:</span><span class="w"> </span><span class="n">libdemo</span>.<span class="n">so</span>.1.0 <span class="n">p_old</span>

<span class="nf">libdemo.so.1.0</span><span class="o">:</span><span class="w"> </span><span class="n">demo_v</span>1.<span class="n">c</span> <span class="n">demo_v</span>1.<span class="n">map</span>
<span class="w">    </span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>-shared<span class="w"> </span>-Wl,-soname,libdemo.so.1<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-Wl,--version-script<span class="o">=</span>demo_v1.map<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>demo_v1.c
<span class="w">    </span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>libdemo.so

<span class="nf">p_old</span><span class="o">:</span><span class="w"> </span><span class="n">main_old</span>.<span class="n">c</span> <span class="n">libdemo</span>.<span class="n">so</span>
<span class="w">    </span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span>-Wl,-rpath,<span class="s1">&#39;$$ORIGIN&#39;</span><span class="w"> </span>-L.<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>main_old.c<span class="w"> </span>-ldemo

<span class="nf">stage2</span><span class="o">:</span><span class="w"> </span><span class="n">libdemo</span>.<span class="n">so</span>.2.0 <span class="n">p_new</span>

<span class="nf">libdemo.so.2.0</span><span class="o">:</span><span class="w"> </span><span class="n">demo_v</span>2.<span class="n">c</span> <span class="n">demo_v</span>2.<span class="n">map</span>
<span class="w">    </span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span><span class="k">$(</span>CFLAGS<span class="k">)</span><span class="w"> </span>-shared<span class="w"> </span>-Wl,-soname,libdemo.so.1<span class="w"> </span><span class="se">\</span>
<span class="w">        </span>-Wl,--version-script<span class="o">=</span>demo_v2.map<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>demo_v2.c
<span class="w">    </span>ln<span class="w"> </span>-sf<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>libdemo.so

<span class="nf">p_new</span><span class="o">:</span><span class="w"> </span><span class="n">main_new</span>.<span class="n">c</span> <span class="n">libdemo</span>.<span class="n">so</span>
<span class="w">    </span><span class="k">$(</span>CC<span class="k">)</span><span class="w"> </span>-Wl,-rpath,<span class="s1">&#39;$$ORIGIN&#39;</span><span class="w"> </span>-L.<span class="w"> </span>-o<span class="w"> </span><span class="nv">$@</span><span class="w"> </span>main_new.c<span class="w"> </span>-ldemo

<span class="nf">inspect</span><span class="o">:</span>
<span class="w">    </span>@echo<span class="w"> </span><span class="s2">&quot;==&gt; Exported (with versions) in libdemo.so&quot;</span>
<span class="w">    </span>@nm<span class="w"> </span>-D<span class="w"> </span>--with-symbol-versions<span class="w"> </span>libdemo.so<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39; foo| bar&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span>@echo<span class="p">;</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;==&gt; Version sections in libdemo.so&quot;</span>
<span class="w">    </span>@readelf<span class="w"> </span>-W<span class="w"> </span>--version-info<span class="w"> </span>libdemo.so<span class="w"> </span><span class="p">|</span><span class="w"> </span>sed<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;1,120p&#39;</span>

<span class="nf">clean</span><span class="o">:</span>
<span class="w">    </span>rm<span class="w"> </span>-f<span class="w"> </span>p_old<span class="w"> </span>p_new<span class="w"> </span>libdemo.so<span class="w"> </span>libdemo.so.*<span class="w"> </span>*.o
</pre></div>
</div>
</div>
<div class="section" id="build-run">
<h2><a class="toc-backref" href="#id4"><span class="section-number">7.3. </span>Build &amp; Run</a><a class="headerlink" href="#build-run" title="Permalink to this heading"></a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stage 1: build first library + &quot;old&quot; app</span>
make<span class="w"> </span>stage1
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_old
<span class="c1"># -&gt; prints: foo v1</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stage 2: replace lib with v2 (keeps SONAME), rebuild &quot;new&quot; app</span>
make<span class="w"> </span>stage2
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_old
<span class="c1"># -&gt; still prints: foo v1  (old app bound to DEMO_1)</span>
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_new
<span class="c1"># -&gt; prints: &quot;foo v2 (default)&quot; and &quot;bar v2&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="inspecting-the-result">
<h2><a class="toc-backref" href="#id5"><span class="section-number">7.4. </span>Inspecting the Result</a><a class="headerlink" href="#inspecting-the-result" title="Permalink to this heading"></a></h2>
<p>See exported symbols and their versions:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nm<span class="w"> </span>-D<span class="w"> </span>--with-symbol-versions<span class="w"> </span>libdemo.so<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39; foo| bar&#39;</span>
<span class="c1"># ... foo@DEMO_1</span>
<span class="c1"># ... foo@@DEMO_2</span>
<span class="c1"># ... bar@@DEMO_2</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> marks the <em>default</em> version; <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> marks a non-default (older) version.</p>
<p>See version metadata sections:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>readelf<span class="w"> </span>-W<span class="w"> </span>--version-info<span class="w"> </span>libdemo.so
</pre></div>
</div>
<p>You should see:</p>
<ul class="simple">
<li><p>Version definitions (from <code class="docutils literal notranslate"><span class="pre">.gnu.version_d</span></code>).</p></li>
<li><p>Per-symbol version indices in <code class="docutils literal notranslate"><span class="pre">.gnu.version</span></code>.</p></li>
<li><p>(In executables) Version needs in <code class="docutils literal notranslate"><span class="pre">.gnu.version_r</span></code>.</p></li>
</ul>
<p>Optional runtime trace from the dynamic linker:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">LD_DEBUG</span><span class="o">=</span>versions<span class="w"> </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_new<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;checking for version|needed&#39;</span>
</pre></div>
</div>
<div class="section" id="b-what-symver-attribute-symver-do">
<h3><a class="toc-backref" href="#id6"><span class="section-number">7.4.1. </span>B. What <code class="docutils literal notranslate"><span class="pre">.symver</span></code> / <code class="docutils literal notranslate"><span class="pre">__attribute__((symver))</span></code> Do</a><a class="headerlink" href="#b-what-symver-attribute-symver-do" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.symver</span></code> (assembler directive)
- Binds a specific implementation symbol to a public name <em>and</em> a version node.
- Syntax: <code class="docutils literal notranslate"><span class="pre">.symver</span> <span class="pre">&lt;impl&gt;,</span> <span class="pre">&lt;public&gt;&#64;&lt;NODE&gt;</span></code> or <code class="docutils literal notranslate"><span class="pre">.symver</span> <span class="pre">&lt;impl&gt;,</span> <span class="pre">&lt;public&gt;&#64;&#64;&lt;NODE&gt;</span></code>.
- <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> marks the default implementation selected by new linkers.
- The version node must exist in the version script when you build the DSO.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">__attribute__((symver(&quot;...&quot;)))</span></code>
- Front-end attribute that makes compiler emit the corresponding <code class="docutils literal notranslate"><span class="pre">.symver</span></code>.
- Handy with LTO because it attaches at the language level.</p></li>
</ul>
<p>Exactly one default definition should exist for a symbol (the one with <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code>).</p>
</div>
<div class="section" id="c-what-a-version-script-does">
<h3><a class="toc-backref" href="#id7"><span class="section-number">7.4.2. </span>C. What a Version Script Does</a><a class="headerlink" href="#c-what-a-version-script-does" title="Permalink to this heading"></a></h3>
<p>A GNU ld <em>version script</em> (use with <code class="docutils literal notranslate"><span class="pre">-Wl,--version-script=...</span></code>):</p>
<ol class="arabic simple">
<li><p>Declares <strong>version nodes</strong> and binds <strong>symbols</strong> to those nodes.</p></li>
<li><p>Controls visibility (<code class="docutils literal notranslate"><span class="pre">global:</span></code> exported; <code class="docutils literal notranslate"><span class="pre">local:</span></code> hidden).</p></li>
<li><p>Supports <strong>inheritance</strong> between nodes to evolve the ABI without bumping the SONAME.</p></li>
<li><p>For C++, you can match demangled names with an <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C++&quot;</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code> block.</p></li>
</ol>
<p>If you want to tag all currently <strong>exported</strong> symbols with one version without changing visibility,
this works:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>V1 { *; };
</pre></div>
</div>
<p>This does not force hidden symbols to become exported; it only tags whatever is already exported.</p>
</div>
<div class="section" id="d-elf-sections-used-by-symbol-versioning">
<h3><a class="toc-backref" href="#id8"><span class="section-number">7.4.3. </span>D. ELF Sections Used by Symbol Versioning</a><a class="headerlink" href="#d-elf-sections-used-by-symbol-versioning" title="Permalink to this heading"></a></h3>
<p>When you link with versioned symbols, the following GNU extension sections (referenced by dynamic
tags) are produced/used:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.gnu.version</span></code> (<em>SHT_GNU_versym</em>, referenced by <code class="docutils literal notranslate"><span class="pre">DT_VERSYM</span></code>)
- A table parallel to <code class="docutils literal notranslate"><span class="pre">.dynsym</span></code> that stores a 16-bit version index per symbol.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.gnu.version_d</span></code> (<em>SHT_GNU_verdef</em>, referenced by <code class="docutils literal notranslate"><span class="pre">DT_VERDEF</span></code>/<code class="docutils literal notranslate"><span class="pre">DT_VERDEFNUM</span></code>)
- Version <strong>definitions</strong> provided by this DSO (node names, indices, hashes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.gnu.version_r</span></code> (<em>SHT_GNU_verneed</em>, referenced by <code class="docutils literal notranslate"><span class="pre">DT_VERNEED</span></code>/<code class="docutils literal notranslate"><span class="pre">DT_VERNEEDNUM</span></code>)
- Version <strong>requirements</strong> (what this module needs from its dependencies).</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">readelf</span> <span class="pre">-W</span> <span class="pre">--version-info</span></code> summarizes these sections so you can verify bindings and defaults.</p>
</div>
<div class="section" id="e-practical-notes-common-pitfalls">
<h3><a class="toc-backref" href="#id9"><span class="section-number">7.4.4. </span>E. Practical Notes &amp; Common Pitfalls</a><a class="headerlink" href="#e-practical-notes-common-pitfalls" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p>C++ name mangling:
- If you version C++ functions with <code class="docutils literal notranslate"><span class="pre">.symver</span></code>, use the <strong>mangled</strong> name.
- In version scripts you can use demangled names inside <code class="docutils literal notranslate"><span class="pre">extern</span> <span class="pre">&quot;C++&quot;</span> <span class="pre">{</span> <span class="pre">...</span> <span class="pre">}</span></code>.</p></li>
<li><p>Default vs. non-default:
- Default shows as <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code>; older variants show as <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>.
- Newly linked apps bind to the default; previously linked apps keep using their recorded version.</p></li>
<li><p>Diagnostics:
- <code class="docutils literal notranslate"><span class="pre">nm</span> <span class="pre">-D</span> <span class="pre">--with-symbol-versions</span></code>: quick view of <code class="docutils literal notranslate"><span class="pre">foo&#64;&#64;V2</span></code> / <code class="docutils literal notranslate"><span class="pre">foo&#64;V1</span></code>.
- <code class="docutils literal notranslate"><span class="pre">readelf</span> <span class="pre">-W</span> <span class="pre">--version-info</span></code>: detailed view of <code class="docutils literal notranslate"><span class="pre">.gnu.version*</span></code> sections.
- <code class="docutils literal notranslate"><span class="pre">LD_DEBUG=versions</span></code>: watch the dynamic linker’s version checks at runtime.</p></li>
</ul>
</div>
<div class="section" id="f-one-page-cheat-sheet">
<h3><a class="toc-backref" href="#id10"><span class="section-number">7.4.5. </span>F. One-Page Cheat Sheet</a><a class="headerlink" href="#f-one-page-cheat-sheet" title="Permalink to this heading"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">.symver</span></code> / <code class="docutils literal notranslate"><span class="pre">__attribute__((symver))</span></code>:
- Attach a version to a symbol definition; exactly one default (<code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code>) per symbol.
- Ensure the version node exists in the link-time version script.</p></li>
<li><p>Version script:
- Define version nodes, bind symbols, control visibility, and express inheritance.
- Can version all currently exported symbols via <code class="docutils literal notranslate"><span class="pre">V1</span> <span class="pre">{</span> <span class="pre">*;</span> <span class="pre">};</span></code>.</p></li>
<li><p>ELF sections:
- <code class="docutils literal notranslate"><span class="pre">.gnu.version</span></code> — per-dynamic-symbol version indices (<code class="docutils literal notranslate"><span class="pre">DT_VERSYM</span></code>).
- <code class="docutils literal notranslate"><span class="pre">.gnu.version_d</span></code> — version definitions (<code class="docutils literal notranslate"><span class="pre">DT_VERDEF*</span></code>).
- <code class="docutils literal notranslate"><span class="pre">.gnu.version_r</span></code> — version requirements (<code class="docutils literal notranslate"><span class="pre">DT_VERNEED*</span></code>).</p></li>
</ul>
</div>
<div class="section" id="appendix-quick-commands">
<h3><a class="toc-backref" href="#id11"><span class="section-number">7.4.6. </span>Appendix: Quick Commands</a><a class="headerlink" href="#appendix-quick-commands" title="Permalink to this heading"></a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build first version and old app</span>
make<span class="w"> </span>stage1
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_old

<span class="c1"># Upgrade library, build new app</span>
make<span class="w"> </span>stage2
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_old
<span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>.<span class="w"> </span>./p_new

<span class="c1"># Inspect exports and versions</span>
nm<span class="w"> </span>-D<span class="w"> </span>--with-symbol-versions<span class="w"> </span>libdemo.so<span class="w"> </span><span class="p">|</span><span class="w"> </span>egrep<span class="w"> </span><span class="s1">&#39; foo| bar&#39;</span>
readelf<span class="w"> </span>-W<span class="w"> </span>--version-info<span class="w"> </span>libdemo.so

<span class="c1"># Trace loader checks</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="linker_diagnostics.html" class="btn btn-neutral float-left" title="5. Diagnostics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="image_structure_and_generation.html" class="btn btn-neutral float-right" title="8. Image Structure and Generation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Qualcomm Technologies, Inc. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>